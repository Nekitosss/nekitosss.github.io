---
layout: post
title: Configuring AWS virtual personal cloud
subtitle: "Theres VPC for that"
tags: [aws, backend, administration]
comments: true
---

![AWS Header](/img/2021-03/aws_vpc/header_image.jpg){: .center-image }

VPC это приватное облако, внутри которого создаются и общаются инстансы EC2 серверов, базы данных, кэши, балансировщики, лямбды и прочее. Это ваш персональный VPN, который можно настроить как вам угодня с учётом всех политик безопасности. При создании аккаунта в AWS, вам выдаётся и полностью конфигурируется дефолтный VPC. Это сделано для того, чтобы вы могли попробовать сервисы AWS без необходимости создания нового VPC. Но для чего нам тогда создавать новую сеть, если для нас уже всё сделано? Создание своей сети позволит вам более гибко сконфигурировать внутренности сети, такие как политики безопасности, диапазоны адресов, доступность ресурсов извне VPC (из сети интернет).

## Создание и конфигурация своего VPC

Всю работу по создании и настроке мы будем производить, очевидно, в VPC сервисе. В поисковую строку сверху вбиваем VPC и переходим к сервису. В AWS есть возможность воспользоваться программой VPC Wizard, которая по указанным предпочтениям настроит сеть за вас. Но вы мало чему научитесь и мало что поймёте, воспользовавшись визардом. Поэтому будем конфигурировать каждый отдельный компонент сети вручную.

Для полной конфигурации пройдём несколько шагов:
1. Создание VPC
2. Создание подсетей
3. Настройка таблиц маршрутизации
4. Конфигурация доступа в интернет
5. Настройка безопасности
    * Access control list (ACL)
    * Security groups

### Создание VPC

Для начала выберите регион, в котором хотите создавать подсеть и создавать сервера в будущем.

Переходим на вкладку `Your VPCs` и нажимаем `Create VPC`.

![VPC Creation](/img/2021-03/aws_vpc/vpc_creation.jpeg){: .center-image }

Нужно задать имя и диапазон IP адресов внутри сети. Имя введите какое вам удобно, в диапазоне аресов укажем `10.0.0.0/16`, заняв максимальное количество (AWS разрешает в качестве маски подсети указывать от 16 до 28, таким образом, максимальное количество адресов внутри сети составляет 65536 адресов). Затем нажимаем `Create` и открывается информация по нашей новой подсети. 

![VPC Settings](/img/2021-03/aws_vpc/vpc_settings.jpeg){: .center-image }

Кажется, что теперь можно переходить в заветный сервис EC2 и создавать себе виртуалки, но всё немного сложнее. Нужно создать подсети, уже к которым как раз и будут привязываться инстансы серверов.
Также после создания персонального облака на него навешиваются политики по умолчанию и оно недоступно извне. Это мы исправим в следующих шагах.

### Создание подсетей

Подсети делятся на публичные и приватные. Всё, что создано в публичных подсетях, доступно извне. Здесь создаются, например, инстансы EC2. Все ресурсы, созданные внутри приватной подсети, доступны только для других ресурсов этой же VPC. В приватных подсетях создаются, например, базы данных.
Также существует такая сущность как зоны доступности (`Availability zone`). Они созданы для физического разделения. Например, когда одна зона упала, можно перекинуть трафик на соседнюю зону в том же регионе. 
Для создания подсети переходим на вкладку `Subnets` и нажимаем `Create Subnet`. 

Указываем созданную VPC как основную точку, где мы создаём наши подсети и затем указываем параметры. Имя подсетям лучше давать понятные и содержащие информацию об этой подсети. Так впоследствии будет гораздо удобнее работать с подсетями и при настройке конфигурации других ресурсов AWS, где необходимо указать подсеть, по названию будет понятно, что вы выбираете. Называем подсеть `my-test-vpc-eu-west-1a-pub`, выбираем регион `<базовый>-1a` в качестве CIDR блока указываем IP `10.0.1.0/24`, что даст нам 2051 адрес внутри сети.

![Subnet settings](/img/2021-03/aws_vpc/subnet_settings.jpeg){: .center-image }

Затем нажимаем `Create`, ждём некоторое время и вуаля, публичная подсеть создана. Сюда мы будем добавлять наши инстансы, которые будут обрабатывать запросы из интернета. 

Теперь нам нужно создать приватную подсеть для базы данных. Снова нажимаем `Create subnet`, снова выбираем нашу VPC, задаём имя `my-test-vpc-au-west-1b-prv`, выбираем регион `1b`, в CIDR задаём `10.0.2.0/24` и создаём подсеть. На данный момент подсети отличаются только именем и обы недоступны извне, нам нужно это исправить и изменить маршрутизацию для публичной `my-test-vpc-eu-west-1a-pub`. Информацию о маршрутизации можно посмотреть, выбрав подсеть в списке и посмотрев свойство `Route table`.

### Создаём Internet gateway и Route table

Для начала создадим Internet gateway. Он нужен для того, чтобы у наших инстансов EC2 в публичной подсети был доступ в интернет. Процесс создания очень прост. Переходим на вкладку `Internet gateways`, нажимаем `Create internet gateway`, задаём имя, например, `my-internet-gateway` и нажимаем `Create`. 
Изначально при создании gateway находится в detached состоянии. Нам нужно привязать его к нашему VPC. Нажимаем `Actions` -> `Attach to VPC`, выбираем наш и подтверждаем.

![Gateway actions](/img/2021-03/aws_vpc/gateway_actions.jpeg){: .center-image }

Но это ещё не всё. Теперь нам нужно создать и сконфигурировать кастомную Route table для нашей публичной подсети. За приватную подсеть будет отвечать дефолтная автоматически созданная для нашей VPC таблица и мы не будем это менять.

Переходим на вкладку `Route tables`, нажимаем `Create route table`, вводим имя `my-test-vpc-rtb-pub`, выбираем наш VPC из выпадающего списка и нажимаем создать. После создания нужно изменить эту таблицу, чтобы она указывала на наш созданный internet gateway. Выделяем нашу таблицу и переходим на вкладку `Routes` снизу. Затем нажимаем там на редактирование.

![Route tables](/img/2021-03/aws_vpc/route_tables.jpeg){: .center-image }

Нам нужно добавить маршрут (`Add route`) и указать интернет в качестве назначения. IP интернета - `0.0.0.0/0`. Не забываем также указать наш gateway в качестве таргета.

![Routes editing](/img/2021-03/aws_vpc/edit_routes.jpeg){: .center-image }

Теперь нам нужно вернуться к списку подсетей, выбрать нашу публичную подсеть и на вкладке `Route table` нажать `Edit route table association`.

![Routes editing](/img/2021-03/aws_vpc/subnet_associations.jpeg){: .center-image }

Внутри нам нужно поменять дефолтную route table на нашу `my-test-vpc-rtb-pub`. После этого мы видим, что публичная подсеть связана с публичной таблицой маршрутизации, которая, в свою очередь, связана с internet gateway. Теперь всё, что мы запустим в публичной подсети, имеет доступ в интернет. Если вы хотите дать доступ в сеть интернет для ресурсов, добавленных в приватную подсеть, существует технология NAT и она выходит за рамки этого туториала.

### Настройки безопасности

Security group работает как виртуальный фаерволл, который контролирует траффик. Без добавления правила, разрешающего доступ к ресурсу в подсети, даже при учёте настройки публичной подсети, security group не пропустит такой коннект. Помимо Security group также существуют ACL, которые работают похожим образом.
При создании VPC помимо дефолтной таблицы маршрутизации, AWS создаёт дефолтные Security group и ACL для приватного облака. Пара полезных фактов:
1. По умолчанию security groups разрешают весь исходящий трафик
2. При настройки security group нельзя добавить запрещающее правило. Можно добавлять только правила, разрешающие какой-то коннект
3. При настройки ACL можно добавить запрещающие правила, которые применяются последовательно на основе Rule number
4. В ACL рекомендуется нумеровать правила сотнями (100, 200, 300), чтобы потом всегда была возможность добавить что-то в середину.

Для наших целей дефолтной ACL вполне достаточно, поэтому мы не будем создавать кастомную.

Создадим Security group для нашей публичной подсети, которую мы будем использовать для коннекта к EC2 инстансу. Переходим на вкладку `Security groups` и нажимаем `Create security group`. В качестве имени задаём `my-pub-security-group`. Не забудьте выбрать нашу VPC вместо дефолтной. 
Теперь в `Inbound rules` нам нужно настроить правила, разрешающие HTTP, HTTPS и SSH траффик для коннекта и настройки сервера.

![Routes editing](/img/2021-03/aws_vpc/inbound_rules.jpeg){: .center-image }

Примечание: Security Group для базы данных можно будет создать прямо при создании инстанса базы данных.

Теперь у нас есть полностью сконфигурированная VPC с подсетями для публичного и приватного доступа, настроенными для коннекта по портам 80, 443 и 22 и с возможностью выхода в интернет. В следующих статьях мы разберём, как создать и сконфигурировать инстансы EC2 для сервера и RDS для нашей базы данных.

## Использованные ресурсы

1. [Оффициальная документация Amazon VPC](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)
2. [Обязательный к просмотру подробный видеотуториал](https://www.youtube.com/watch?v=fpxDGU2KdkA)